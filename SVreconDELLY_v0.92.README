#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Title:               SVreconDELLY
# Version:  		       v0.92 
# Author:              Jesper Bramsen (bramsen@clin.au.dk)
# Date:                2025-05-01
# Last Update:	       2025-05-01
# Dependencies in R:	 "dplyr", "stringr", "data.table", "GenomicRanges", "BSgenome.Hsapiens.UCSC.hg38","tidyr","Biostrings"
# Built:			         Built and tested using R v4.4.2; dplyr v1.1.4; stringr v1.5.1; data.table v1.16.2; GenomicRanges v1.56.2; BSgenome.Hsapiens.UCSC.hg38 v1.4.5; tidyr v1.3.1 ,Biostrings v2.72.1
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# The R function "SVreconDelly" filters Somatic Structural variant (SV) calls predicted by DELLY by attempting to reconstruct their predicted CONTIG sequence from reference genomic sequences and, if successfull, outputs genomic postions and sequences that can be used for downstream BLAST and mutspy analysis, as described in Ellegaard et al. 
# The filtering is strict and will strongly favor simple SVs, where the predicted SV contig ("CONSENSUS" in the input .vcf file "INFO" field) can be fylly reconstructed using only the information in the input .vcf file and GRCh38 reference genome sequences.     

# Input for SVreconDELLY is two arguments:
# Argument 1: vcf_file ("path/to/your/file.vcf")
# - The input .vcf or .vcf.gz file must be generated by Delly (PMID: 22962449) and contain only somatic SV calls (i.e. "SOMATIC" in "INFO" FIELD). Only SVs with a predicted CONSENSUS in the INFO FIELD can be processed. The pipeline was built using SVMETHOD=EMBL.DELLYv0.9.1.  
# Argument 2: output_folder ("your/output/folder/")
# - Three output files per sample is written to the output folder (see below).

# Run SVreconDELLY in R (upon installing all dependencies) by running the following R commands
# source("path/to/SVreconDELLY_v92.R")
# SVreconDELLY("path/to/your/file.vcf","your/output/folder/")

# In overview, SVreconDELLY will: 
# 1) Process only SVs with a "CONSENSUS" sequence (SV contig) in the INFO field and removes SVs marked as “IMPRECISE”. Retain only SVs with FILTER == "PASS" 
# 2) Optionally, filter SVs by MinMAPQ and srMAPQ scores in the INFO field (default MinMAPQ = 0).
# 3) Reconstruct the predicted SV using only breakpoints from the input VCF and the GRCh38 reference genome.
# 4) Attempt to use the reconstructed SV to insert SV breakpoint positions and perfect homology regions (HOMSEQ) between donor sites into the SV contig ("CONSENSUS" in INFO field). Next, extract SV breakpoint flanking sequences for downstream mutspy analysis in the output "SampleID_DELLYrecon_SVmutspy.txt"
# 5) Generate genomic positions of SV donor sites for whole-genome coverage analysis. Output is stored in the output file "SampleID_DELLYrecon_DONOR.bed"
# 6) Produce 50mer+ breakpoint-centered SV contig (with predicted homology) for downstream filtering e.g. by pangenome BLAST as in Ellegaard et al. Output is stored in the output file "SampleID_DELLYrecon_SV50.fa"

# The SVreconDelly output the following three files in "output_folder" using the .vcf filename (without its extension) as the SampleID: 
# 1) "SampleID_DELLYrecon_SVmutspy.txt" contains information from the SV reconstruction analysis, including SV motifs to serve as input for SV mutspy.
# 2) "SampleID_DELLYrecon_DONOR.bed" contains SV donor genomic positions in BED format, suitable for input into WGS coverage analysis..  
# 3) "SampleID_DELLYrecon_SV50.fa" contains truncated SV contigs (= 50 bp) in FASTA format, ready for BLAST searches against reference genomes.

# Specifically, the output "SampleID_DELLYrecon_SVmutspy.txt" has the follwoing columns 
# Column 1:		"SV_predictions_tool"	  		: Tool used for generation of the input .vcf file containing predctions of somatic SVs, here "DELLY"
# Column 2: 	"SVrecon_pipeline" 		    	: SVrecon_pipeline_version
# Column 3:		"SVrecon_Parameters"			  : Values for "GenomicFlank", "CountFlank", "maxHom" and "MinMAPQ" used in SVrecon analysis 
# Column 4:		"Sample_ID" 				        : "sampleID" taken from the vcf file name
# Column 5:		"SV_ID"	 				            : The ID of the SV extracted from the ID columns of the input .vcf file
# Column 6:		"Genomic_Position1"			    : Genomic position of the donor site 1 extracted from the "CHROM" and "POS" columns of the input .vcf file
# Column 7:		"Genomic_Position2"			    : Genomic position of the donor site 2 extracted from the "INFO" field of the input .vcf file
# Column 8:		"SVtype"					          : The SVtype as annotated in the "INFO" field of the input .vcf file
# Column 9:		"SVtypeClass"				        : The SVtypeClass annotated by SVreconDelly during processing of the SVs.
# Column 10:	"SVLEN"					            : The SVLEN as annotated in the "INFO" field of the input .vcf file
# Column 11:	"SV_length_estimate"			  : Approximate estimate of SV length calculated as the difference between "Genomic_Position1" and "Genomic_Position2"
# Column 12:	"SV_CONTIG"					        : The SV consensus sequences extrated from the input .vcf file "INFO" field
# Column 13:	"SV_CONTIG_w.Pred.BreakSite	: The SV consensus sequences extrated from the VCF INFO field, where the SV breakpoint (BP) is predicted by SV reconstruction and indicated with brackets []. Predicted Homology regions are located within brackets.
# Column 14:	"Pred.Breakpoint_Quality"		: Rough estimate of the validity of the predicted breakpoint in the SV CONTIG, divided into three catagories "Good", "Fair" and "Poor". 
# Column 15:	"SV_mutspy_input"				    : SV sequence motif that can be used as input in mutspy analysis (as described in Ellegaard et al.) 
#
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
